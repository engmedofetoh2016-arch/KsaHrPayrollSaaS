<section class="dashboard">
  <div class="hero">
    <div>
      <p class="eyebrow">{{ i18n.text('HR + Payroll Control Center', 'مركز التحكم للموارد البشرية والرواتب') }}</p>
      <h1>{{ i18n.text('Welcome back,', 'مرحبا بعودتك،') }} {{ session()?.firstName }}</h1>
      <p class="sub">
        {{
          i18n.text(
            'Run payroll faster with one workspace for employees, attendance, and monthly payroll execution.',
            'شغل الرواتب أسرع عبر مساحة واحدة للموظفين والحضور وتنفيذ رواتب الشهر.'
          )
        }}
      </p>
    </div>
    <div class="hero-chip">
      <span class="dot"></span>
      <span>{{ i18n.text('Live tenant session', 'جلسة شركة نشطة') }}</span>
    </div>
  </div>

  <div class="kpis">
    <article class="kpi">
      <p class="label">{{ i18n.text('Employees', 'الموظفون') }}</p>
      <p class="value">{{ stats().employees }}</p>
      <p class="meta">{{ i18n.text('Active in this tenant', 'النشطون في هذه الشركة') }}</p>
    </article>

    <article class="kpi">
      <p class="label">{{ i18n.text('Attendance (This Month)', 'الحضور (هذا الشهر)') }}</p>
      <p class="value">{{ stats().attendanceRowsThisMonth }}</p>
      <p class="meta">{{ i18n.text('Rows captured', 'مدخلات مسجلة') }}</p>
    </article>

    <article class="kpi">
      <p class="label">{{ i18n.text('Payroll Periods', 'فترات الرواتب') }}</p>
      <p class="value">{{ stats().payrollPeriods }}</p>
      <p class="meta">{{ i18n.text('Created so far', 'تم إنشاؤها حتى الآن') }}</p>
    </article>

    @if (canSeeUsers()) {
      <article class="kpi">
        <p class="label">{{ i18n.text('Users', 'المستخدمون') }}</p>
        <p class="value">{{ stats().users }}</p>
        <p class="meta">{{ i18n.text('Owner/Admin/HR/Manager', 'مالك/مدير/موارد بشرية/مشرف') }}</p>
      </article>
    }

    <article class="kpi">
      <p class="label">{{ i18n.text('Saudization', 'السعودة') }}</p>
      <p class="value">{{ saudization().percent }}%</p>
      <p class="meta">{{ saudization().saudi }} / {{ saudization().total }} {{ i18n.text('Saudi employees', 'موظف سعودي') }}</p>
    </article>

    <article class="kpi">
      <p class="label">{{ i18n.text('Expiring Docs (60d)', 'مستندات تنتهي خلال 60 يوم') }}</p>
      <p class="value">{{ stats().expiringDocuments }}</p>
      <p class="meta">
        {{ i18n.text('Iqama', 'الإقامة') }}: {{ stats().expiringIqama }} |
        {{ i18n.text('Work Permit', 'رخصة العمل') }}: {{ stats().expiringWorkPermit }}
      </p>
    </article>
  </div>

  <div class="grid">
    <article class="panel">
      <h3>{{ i18n.text('Quick Actions', 'Quick Actions') }}</h3>
      <div class="actions">
        @if (isEmployee()) {
          <a routerLink="/employee/profile">{{ i18n.text('My Profile', 'My Profile') }}</a>
          <a routerLink="/employee/payslips">{{ i18n.text('My Payslips', 'My Payslips') }}</a>
          <a routerLink="/leave/my">{{ i18n.text('My Leave', 'إجازاتي') }}</a>
        } @else {
          <a routerLink="/employees">{{ i18n.text('Add Employee', 'Add Employee') }}</a>
          <a routerLink="/attendance">{{ i18n.text('Capture Attendance', 'Capture Attendance') }}</a>
          <a routerLink="/payroll">{{ i18n.text('Run Payroll', 'Run Payroll') }}</a>
          <a routerLink="/final-settlement">{{ i18n.text('Final Settlement', 'Final Settlement') }}</a>
          <a routerLink="/company">{{ i18n.text('Update Company Settings', 'Update Company Settings') }}</a>
        }
      </div>
      @if (isEmployee()) {
        <div class="latest-payslip">
          <p class="meta">{{ i18n.text('Latest Payslip', 'Latest Payslip') }}</p>
          @if (latestPayslip(); as payslip) {
            <p class="meta">{{ payslip.periodYear }}/{{ payslip.periodMonth.toString().padStart(2, '0') }} - {{ payslip.fileName }}</p>
            <button type="button" class="action-button" (click)="downloadLatestPayslip()" [disabled]="latestPayslipBusy() || payslip.status !== 3">
              {{ i18n.text('Download Latest Payslip', 'Download Latest Payslip') }}
            </button>
          } @else {
            <p class="meta">{{ i18n.text('No payslip has been generated yet.', 'No payslip has been generated yet.') }}</p>
          }
        </div>
      }
    </article>
    <article class="panel wps">
      <h3>{{ i18n.text('WPS Readiness', 'جاهزية حماية الأجور') }}</h3>
      @if (wpsReadiness().ready) {
        <p class="ok">{{ i18n.text('Ready for WPS export.', 'جاهز لتصدير ملف حماية الأجور.') }}</p>
      } @else {
        <p class="warn">{{ i18n.text('Configuration is incomplete.', 'الإعدادات غير مكتملة.') }}</p>
      }
      <ul>
        <li>
          {{ i18n.text('Company bank profile', 'ملف البنك للشركة') }}:
          {{ wpsReadiness().companyReady ? i18n.text('Complete', 'مكتمل') : i18n.text('Missing data', 'بيانات ناقصة') }}
        </li>
        <li>
          {{ i18n.text('Employees missing payment profile', 'موظفون ينقصهم ملف دفع') }}:
          {{ wpsReadiness().employeesMissingPayment }} / {{ wpsReadiness().totalEmployees }}
        </li>
      </ul>
      <div class="actions">
        <a routerLink="/company">{{ i18n.text('Fix Company WPS Settings', 'إكمال إعدادات WPS للشركة') }}</a>
        <a routerLink="/employees">{{ i18n.text('Complete Employee Bank Data', 'إكمال بيانات بنك الموظفين') }}</a>
      </div>
    </article>

    <article
      class="panel saudization"
      [class.risk-low]="saudization().risk === 'low'"
      [class.risk-medium]="saudization().risk === 'medium'"
      [class.risk-high]="saudization().risk === 'high'">
      <h3>{{ i18n.text('Saudization Risk', 'مخاطر التوطين') }}</h3>
      <p class="risk-label">
        @if (saudization().risk === 'low') {
          {{ i18n.text('Low Risk', 'مخاطر منخفضة') }}
        } @else if (saudization().risk === 'medium') {
          {{ i18n.text('Medium Risk', 'مخاطر متوسطة') }}
        } @else {
          {{ i18n.text('High Risk', 'مخاطر عالية') }}
        }
      </p>
      <p class="meta">{{ i18n.text('Current Saudization', 'نسبة التوطين الحالية') }}: {{ saudization().percent }}%</p>
      <p class="meta">{{ i18n.text('Target reference', 'الهدف المرجعي') }}: 30%</p>
      <div class="actions">
        <a routerLink="/employees">{{ i18n.text('Review Employee Nationality', 'مراجعة جنسيات الموظفين') }}</a>
      </div>
    </article>

    <article class="panel docs" [class.risk-high]="stats().expiringDocuments > 5" [class.risk-medium]="stats().expiringDocuments > 0 && stats().expiringDocuments <= 5">
      <h3>{{ i18n.text('Expiry Alerts', 'تنبيهات انتهاء المستندات') }}</h3>
      <p class="risk-label">
        @if (stats().expiringDocuments === 0) {
          {{ i18n.text('No urgent expiries', 'لا توجد تواريخ انتهاء عاجلة') }}
        } @else {
          {{ i18n.text('Action required', 'يلزم اتخاذ إجراء') }}
        }
      </p>
      <p class="meta">{{ i18n.text('Iqama expiring in 60 days', 'إقامات تنتهي خلال 60 يوم') }}: {{ stats().expiringIqama }}</p>
      <p class="meta">{{ i18n.text('Work permits expiring in 60 days', 'رخص عمل تنتهي خلال 60 يوم') }}: {{ stats().expiringWorkPermit }}</p>
      <div class="actions">
        <a routerLink="/employees">{{ i18n.text('Review Employee Documents', 'مراجعة مستندات الموظفين') }}</a>
      </div>
      @if (complianceAlerts().items.length > 0) {
        <table class="mini-table">
          <thead>
            <tr>
              <th>{{ i18n.text('Employee', 'الموظف') }}</th>
              <th>{{ i18n.text('Document', 'المستند') }}</th>
              <th>{{ i18n.text('Severity', 'الأولوية') }}</th>
              <th>{{ i18n.text('Days Left', 'الأيام المتبقية') }}</th>
              <th>{{ i18n.text('Action', 'إجراء') }}</th>
            </tr>
          </thead>
          <tbody>
            @for (alert of complianceAlerts().items; track alert.id + alert.documentType + alert.expiryDate) {
              <tr>
                <td>{{ alert.employeeName }}</td>
                <td>{{ alert.documentType === 'Iqama' ? i18n.text('Iqama', 'الإقامة') : i18n.text('Work Permit', 'رخصة العمل') }}</td>
                <td>{{ alert.severity ?? '-' }}</td>
                <td>{{ alert.daysLeft }}</td>
                <td>
                  <button type="button" (click)="resolveAlert(alert.id)" [disabled]="resolvingAlertIds().includes(alert.id)">
                    {{ i18n.text('Resolve', 'إغلاق') }}
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      }
    </article>

    <article class="panel ai">
      <h3>{{ i18n.text('Smart Compliance Engine', 'محرك الامتثال الذكي') }}</h3>
      <p class="meta">
        {{ i18n.text('Compliance Score', 'درجة الامتثال') }}:
        <strong>{{ complianceScore().score }}/100 ({{ complianceScore().grade }})</strong>
      </p>
      <p class="meta">
        {{ i18n.text('Open risks', 'المخاطر المفتوحة') }}:
        {{ complianceScore().criticalAlerts }} {{ i18n.text('critical', 'حرج') }},
        {{ complianceScore().warningAlerts }} {{ i18n.text('warning', 'متوسط') }},
        {{ complianceScore().noticeAlerts }} {{ i18n.text('notice', 'تنبيه') }}
      </p>
      <p class="meta">{{ i18n.text('AI Brief', 'الملخص الذكي') }} ({{ complianceBrief().provider }})</p>
      <pre class="brief">{{ complianceBrief().brief }}</pre>
      @if (complianceScore().recommendations.length > 0) {
        <ul>
          @for (item of complianceScore().recommendations; track item) {
            <li>{{ item }}</li>
          }
        </ul>
      }
    </article>

    @if (canSeeGovernance()) {
      <article
        class="panel governance"
        [class.risk-high]="governanceRisk() === 'high'"
        [class.risk-medium]="governanceRisk() === 'medium'"
        [class.risk-low]="governanceRisk() === 'low'">
        <h3>{{ i18n.text('Approval Governance (30d)', 'حوكمة الاعتمادات (30 يوم)') }}</h3>
        <p class="meta">
          {{ i18n.text('Total approvals', 'إجمالي الاعتمادات') }}:
          <strong>{{ payrollGovernance().totalApprovals }}</strong>
        </p>
        <p class="meta">
          {{ i18n.text('Overrides', 'التجاوزات') }}:
          <strong>{{ payrollGovernance().overrideApprovals }}</strong>
          ({{ payrollGovernance().overrideRatePercent }}%)
        </p>
        <p class="meta">
          {{ i18n.text('Overrides with reference', 'التجاوزات ذات المرجع') }}:
          <strong>{{ payrollGovernance().overridesWithReference }}</strong>
          ({{ payrollGovernance().overrideReferenceCoveragePercent }}%)
        </p>
        <p class="meta">
          {{ i18n.text('Documentation quality', 'جودة التوثيق') }}:
          <strong>{{ payrollGovernance().overrideDocumentationQualityPercent }}%</strong>
        </p>
        <p class="meta">
          {{ i18n.text('Risk Threshold', 'حد المخاطر') }}:
          @if (governanceRisk() === 'high') {
            <strong>{{ i18n.text('High (> 15%)', 'مرتفع (> 15%)') }}</strong>
          } @else if (governanceRisk() === 'medium') {
            <strong>{{ i18n.text('Medium (5% - 15%)', 'متوسط (5% - 15%)') }}</strong>
          } @else {
            <strong>{{ i18n.text('Low (< 5%)', 'منخفض (< 5%)') }}</strong>
          }
        </p>
        <p class="meta">
          {{ i18n.text('Standard approvals', 'الاعتمادات القياسية') }}:
          <strong>{{ payrollGovernance().standardApprovals }}</strong>
        </p>
        <p class="meta">
          {{ i18n.text('Decisions with critical findings', 'قرارات بها ملاحظات حرجة') }}:
          <strong>{{ payrollGovernance().criticalDecisionCount }}</strong>
        </p>
        <h4>{{ i18n.text('Top Critical Anomalies', 'أكثر الانحرافات الحرجة') }}</h4>
        @if (payrollGovernance().topCriticalCodes.length === 0) {
          <p class="meta">{{ i18n.text('No critical override history in this window.', 'لا يوجد سجل تجاوزات حرجة في هذه الفترة.') }}</p>
        } @else {
          <ul>
            @for (item of payrollGovernance().topCriticalCodes; track item.code) {
              <li>
                <button type="button" class="code-link" (click)="loadGovernanceDecisionsByCode(item.code)">
                  <code>{{ item.code }}</code>: {{ item.count }}
                </button>
              </li>
            }
          </ul>
        }

        <h4>{{ i18n.text('Top Override Categories', 'أكثر فئات التجاوز') }}</h4>
        @if (payrollGovernance().topOverrideCategories.length === 0) {
          <p class="meta">{{ i18n.text('No override categories recorded.', 'لا توجد فئات تجاوز مسجلة.') }}</p>
        } @else {
          <ul>
            @for (item of payrollGovernance().topOverrideCategories; track item.category) {
              <li><code>{{ item.category }}</code>: {{ item.count }}</li>
            }
          </ul>
        }

        @if (governanceDecisionDrilldown().selectedCode) {
          <div class="drilldown-head">
            <h4>
              {{ i18n.text('Decisions For Code', 'القرارات الخاصة بالرمز') }}:
              <code>{{ governanceDecisionDrilldown().selectedCode }}</code>
            </h4>
            <button type="button" (click)="clearGovernanceDrilldown()">
              {{ i18n.text('Clear', 'مسح') }}
            </button>
          </div>

          @if (governanceDecisionDrilldown().loading) {
            <p class="meta">{{ i18n.text('Loading decisions...', 'جاري تحميل القرارات...') }}</p>
          } @else if (governanceDecisionDrilldown().items.length === 0) {
            <p class="meta">{{ i18n.text('No decisions found for this code in 30 days.', 'لا توجد قرارات لهذا الرمز خلال 30 يوماً.') }}</p>
          } @else {
            <div class="table-wrap">
              <table class="mini-table">
                <thead>
                  <tr>
                    <th>{{ i18n.text('When', 'الوقت') }}</th>
                    <th>{{ i18n.text('Type', 'النوع') }}</th>
                    <th>{{ i18n.text('Category', 'الفئة') }}</th>
                    <th>{{ i18n.text('Reference', 'المرجع') }}</th>
                    <th>{{ i18n.text('Run', 'التشغيل') }}</th>
                    <th>{{ i18n.text('Reason', 'السبب') }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (decision of governanceDecisionDrilldown().items; track decision.id) {
                    <tr>
                      <td>{{ decision.createdAtUtc | date: 'short' }}</td>
                      <td>{{ decision.decisionType }}</td>
                      <td>{{ decision.category || '-' }}</td>
                      <td>{{ decision.referenceId || '-' }}</td>
                      <td>
                        @if (decision.runId) {
                          <a [routerLink]="['/payroll']" [queryParams]="{ runId: decision.runId }">
                            {{ decision.runId }}
                          </a>
                        } @else {
                          -
                        }
                      </td>
                      <td>{{ decision.reason || '-' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        }

        <h4>{{ i18n.text('Override Rate Trend (6m)', 'اتجاه معدل التجاوز (6 أشهر)') }}</h4>
        @if (payrollGovernanceTrend().length === 0) {
          <p class="meta">{{ i18n.text('No trend data yet.', 'لا توجد بيانات اتجاه حتى الآن.') }}</p>
        } @else {
          <div class="trend">
            @for (point of payrollGovernanceTrend(); track point.month) {
              <div class="bar" [style.height]="governanceBarHeight(point.overrideRatePercent)" [title]="point.month + ': ' + point.overrideRatePercent + '%'">
                <span>{{ point.overrideRatePercent }}%</span>
                <small>{{ point.month }}</small>
              </div>
            }
          </div>
        }
      </article>
    }

    @if (canSeePayrollIntelligence()) {
      <article class="panel intelligence" [class.risk-high]="payrollIntelligence().runsWithBlocking > 0">
        <h3>{{ i18n.text('Payroll Intelligence', 'Payroll Intelligence') }}</h3>
        <p class="meta">
          {{ i18n.text('Recent runs scanned', 'Recent runs scanned') }}:
          <strong>{{ payrollIntelligence().runsScanned }}</strong>
        </p>
        <p class="meta">
          {{ i18n.text('Blocking runs', 'Blocking runs') }}:
          <strong>{{ payrollIntelligence().runsWithBlocking }}</strong>
        </p>
        <p class="meta">
          {{ i18n.text('Findings', 'Findings') }}:
          {{ i18n.text('Critical', 'Critical') }} {{ payrollIntelligence().criticalFindings }},
          {{ i18n.text('Warning', 'Warning') }} {{ payrollIntelligence().warningFindings }},
          {{ i18n.text('Notice', 'Notice') }} {{ payrollIntelligence().noticeFindings }}
        </p>

        @if (payrollIntelligenceLoading()) {
          <p class="meta">{{ i18n.text('Analyzing payroll runs...', 'Analyzing payroll runs...') }}</p>
        } @else if (payrollIntelligenceError()) {
          <p class="error">{{ payrollIntelligenceError() }}</p>
        } @else if (payrollIntelligence().items.length === 0) {
          <p class="meta">{{ i18n.text('No recent payroll runs found for intelligence checks.', 'No recent payroll runs found for intelligence checks.') }}</p>
        } @else {
          <div class="table-wrap">
            <table class="mini-table">
              <thead>
                <tr>
                  <th>{{ i18n.text('Run', 'Run') }}</th>
                  <th>{{ i18n.text('Block', 'Block') }}</th>
                  <th>{{ i18n.text('Critical', 'Critical') }}</th>
                  <th>{{ i18n.text('Warning', 'Warning') }}</th>
                  <th>{{ i18n.text('Notice', 'Notice') }}</th>
                  <th>{{ i18n.text('Top Finding', 'Top Finding') }}</th>
                </tr>
              </thead>
              <tbody>
                @for (row of payrollIntelligence().items; track row.runId) {
                  <tr>
                    <td>
                      <a [routerLink]="['/payroll']" [queryParams]="{ runId: row.runId }">{{ row.runId }}</a>
                    </td>
                    <td>{{ row.hasBlockingFindings ? i18n.text('Yes', 'Yes') : i18n.text('No', 'No') }}</td>
                    <td>{{ row.critical }}</td>
                    <td>{{ row.warning }}</td>
                    <td>{{ row.notice }}</td>
                    <td>{{ row.topFinding || '-' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </article>
    }

    <article class="panel status">
      <h3>{{ i18n.text('System Status', 'حالة النظام') }}</h3>
      @if (loading()) {
        <p>{{ i18n.text('Refreshing metrics...', 'جاري تحديث المؤشرات...') }}</p>
      } @else {
        <ul>
          <li>{{ i18n.text('API connectivity: OK', 'اتصال API: جيد') }}</li>
          <li>{{ i18n.text('Tenant context: Active', 'سياق الشركة: نشط') }}</li>
          <li>{{ i18n.text('Role profile:', 'الأدوار:') }} {{ session()?.roles?.join(', ') }}</li>
        </ul>
      }
      @if (error()) {
        <p class="error">{{ error() }}</p>
      }
    </article>
  </div>
</section>

