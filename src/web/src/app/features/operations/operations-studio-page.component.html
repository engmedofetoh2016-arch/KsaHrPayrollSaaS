<section class="ops-page">
  <header>
    <h1>{{ i18n.text('Operations Studio', 'استوديو العمليات') }}</h1>
    <p>{{ i18n.text('Configure payroll workflows, compliance rules, forecasting, notifications, and data quality.', 'تهيئة سير عمل الرواتب وقواعد الامتثال والتنبؤات والإشعارات وجودة البيانات.') }}</p>
    <button type="button" (click)="refresh()" [disabled]="loading() || saving()">{{ i18n.text('Refresh', 'تحديث') }}</button>
    <button type="button" class="toggle-codes" (click)="toggleTechnicalCodes()">
      {{ showTechnicalCodes() ? i18n.text('Hide Technical Codes', 'إخفاء الأكواد التقنية') : i18n.text('Show Technical Codes', 'إظهار الأكواد التقنية') }}
    </button>
  </header>

  @if (error()) {
    <p class="error">{{ error() }}</p>
  }
  @if (message()) {
    <p class="message">{{ message() }}</p>
  }

  <div class="grid">
    <article>
      <h2>{{ i18n.text('Allowance Matrix', 'مصفوفة البدلات') }}</h2>
      <div class="form">
        <input [(ngModel)]="allowanceForm.policyName" [placeholder]="i18n.text('Policy Name', 'اسم السياسة')" />
        <input [(ngModel)]="allowanceForm.gradeCode" [placeholder]="i18n.text('Grade', 'الدرجة')" />
        <input [(ngModel)]="allowanceForm.locationCode" [placeholder]="i18n.text('Location', 'الموقع')" />
        <input [(ngModel)]="allowanceForm.housingAmount" type="number" [placeholder]="i18n.text('Housing', 'السكن')" />
        <input [(ngModel)]="allowanceForm.transportAmount" type="number" [placeholder]="i18n.text('Transport', 'النقل')" />
        <input [(ngModel)]="allowanceForm.mealAmount" type="number" [placeholder]="i18n.text('Meal', 'الوجبات')" />
        <input [(ngModel)]="allowanceForm.effectiveFrom" type="date" />
        <button type="button" (click)="saveAllowanceMatrix()" [disabled]="saving()">{{ i18n.text('Save Matrix Row', 'حفظ سطر المصفوفة') }}</button>
      </div>
      <small>{{ allowanceMatrix().length }} {{ i18n.text('rows', 'سجل') }}</small>
    </article>

    <article>
      <h2>{{ i18n.text('Payroll Approval Matrix', 'مصفوفة اعتماد الرواتب') }}</h2>
      <div class="form">
        <button type="button" (click)="seedApprovalMatrix()" [disabled]="saving()">{{ i18n.text('Seed Default Flow', 'تهيئة المسار الافتراضي') }}</button>
        <input [(ngModel)]="stageForm.stageCode" [placeholder]="i18n.text('Stage Code', 'رمز المرحلة')" />
        <small class="code-hint">
          {{ codeLabel(stageForm.stageCode) }}
          @if (showTechnicalCodes()) {
            <span class="code-tech">{{ stageForm.stageCode }}</span>
          }
        </small>
        <input [(ngModel)]="stageForm.stageName" [placeholder]="i18n.text('Stage Name', 'اسم المرحلة')" />
        <input [(ngModel)]="stageForm.stageOrder" type="number" [placeholder]="i18n.text('Order', 'الترتيب')" />
        <input [(ngModel)]="stageForm.approverRole" [placeholder]="i18n.text('Approver Role', 'دور المعتمد')" />
        <label>
          <input type="checkbox" [(ngModel)]="stageForm.autoApproveEnabled" />
          {{ i18n.text('Auto-Approve Stage', 'اعتماد المرحلة تلقائيا') }}
        </label>
        <input
          [(ngModel)]="stageForm.slaEscalationHours"
          type="number"
          min="0"
          [placeholder]="i18n.text('SLA Escalation Hours', 'ساعات تصعيد SLA')" />
        <input [(ngModel)]="stageForm.escalationRole" [placeholder]="i18n.text('Escalation Role', 'دور التصعيد')" />
        <button type="button" (click)="saveApprovalStage()" [disabled]="saving()">{{ i18n.text('Save Stage', 'حفظ المرحلة') }}</button>
      </div>
      <small>{{ approvalMatrix().length }} {{ i18n.text('active stages', 'مرحلة نشطة') }}</small>
      <ul>
        @for (item of approvalMatrix(); track item.id) {
          <li>
            <span>{{ item.stageName || codeLabel(item.stageCode) }}</span>
            <small>
              {{
                i18n.text('Auto', 'تلقائي')
              }}: {{ item.autoApproveEnabled ? i18n.text('Yes', 'نعم') : i18n.text('No', 'لا') }} |
              SLA: {{ item.slaEscalationHours ?? 0 }}h |
              {{ i18n.text('Escalate To', 'التصعيد إلى') }}: {{ item.escalationRole || '-' }}
            </small>
            @if (showTechnicalCodes()) {
              <small class="code-tech">{{ item.stageCode }}</small>
            }
          </li>
        }
      </ul>
    </article>

    <article>
      <h2>{{ i18n.text('Compliance Rules Studio', 'استوديو قواعد الامتثال') }}</h2>
      <div class="form">
        <input [(ngModel)]="ruleForm.ruleCode" [placeholder]="i18n.text('Rule Code', 'رمز القاعدة')" />
        <small class="code-hint">
          {{ codeLabel(ruleForm.ruleCode) }}
          @if (showTechnicalCodes()) {
            <span class="code-tech">{{ ruleForm.ruleCode }}</span>
          }
        </small>
        <input [(ngModel)]="ruleForm.ruleName" [placeholder]="i18n.text('Rule Name', 'اسم القاعدة')" />
        <input [(ngModel)]="ruleForm.ruleCategory" [placeholder]="i18n.text('Category', 'الفئة')" />
        <input [(ngModel)]="ruleForm.severity" [placeholder]="i18n.text('Severity', 'الأولوية')" />
        <textarea [(ngModel)]="ruleForm.ruleConfigJson" rows="3" [placeholder]="i18n.text('Rule Config JSON', 'إعداد القاعدة (JSON)')"></textarea>
        <button type="button" (click)="saveComplianceRule()" [disabled]="saving()">{{ i18n.text('Save Rule', 'حفظ القاعدة') }}</button>
      </div>
      <small>{{ complianceRules().length }} {{ i18n.text('enabled rules', 'قاعدة مفعلة') }}</small>
      <ul>
        @for (item of complianceRules(); track item.id) {
          <li>
            <span>{{ item.ruleName || codeLabel(item.ruleCode) }}</span>
            @if (showTechnicalCodes()) {
              <small class="code-tech">{{ item.ruleCode }}</small>
            }
          </li>
        }
      </ul>
    </article>

    <article>
      <h2>{{ i18n.text('Analytics & Forecasting', 'التحليلات والتنبؤ') }}</h2>
      <div class="form">
        <input [(ngModel)]="forecastForm.scenarioName" [placeholder]="i18n.text('Scenario Name', 'اسم السيناريو')" />
        <input [(ngModel)]="forecastForm.plannedSaudiHires" type="number" [placeholder]="i18n.text('Saudi Hires', 'توظيف سعوديين')" />
        <input [(ngModel)]="forecastForm.plannedNonSaudiHires" type="number" [placeholder]="i18n.text('Non-Saudi Hires', 'توظيف غير سعوديين')" />
        <input [(ngModel)]="forecastForm.plannedAttrition" type="number" [placeholder]="i18n.text('Attrition', 'الاستقالات/المغادرات')" />
        <input [(ngModel)]="forecastForm.plannedSalaryDeltaPercent" type="number" [placeholder]="i18n.text('Salary Delta %', 'نسبة تغير الرواتب %')" />
        <button type="button" (click)="createForecastScenario()" [disabled]="saving()">{{ i18n.text('Create Scenario', 'إنشاء سيناريو') }}</button>
      </div>
      <ul>
        @for (item of forecastScenarios(); track item.id) {
          <li>
            {{ item.scenarioName }}
            <button type="button" (click)="runForecastScenario(item.id)" [disabled]="saving()">{{ i18n.text('Run', 'تشغيل') }}</button>
          </li>
        }
      </ul>
    </article>
    <article>
      <h2>{{ i18n.text('ESS Requests Review', 'مراجعة طلبات الخدمة الذاتية') }}</h2>
      <small>{{ selfServiceRequests().length }} {{ i18n.text('submitted requests', 'طلبات مرسلة') }}</small>
      <ul>
        @for (item of selfServiceRequests(); track item.id) {
          <li>
            <span>{{ item.employeeName || '-' }} - {{ codeLabel(item.requestType) }} ({{ item.status }})</span>
            <button type="button" (click)="reviewSelfServiceRequest(item.id, true)" [disabled]="saving()">{{ i18n.text('Approve', 'اعتماد') }}</button>
            <button type="button" (click)="reviewSelfServiceRequest(item.id, false)" [disabled]="saving()">{{ i18n.text('Reject', 'رفض') }}</button>
          </li>
        }
      </ul>
    </article>

    <article>
      <h2>{{ i18n.text('Notification Center', 'مركز الإشعارات') }}</h2>
      <div class="form">
        <input [(ngModel)]="templateForm.templateCode" [placeholder]="i18n.text('Template Code', 'رمز القالب')" />
        <small class="code-hint">
          {{ codeLabel(templateForm.templateCode) }}
          @if (showTechnicalCodes()) {
            <span class="code-tech">{{ templateForm.templateCode }}</span>
          }
        </small>
        <input [value]="i18n.text('Email only', 'البريد الإلكتروني فقط')" readonly />
        <input [(ngModel)]="templateForm.subject" [placeholder]="i18n.text('Subject', 'العنوان')" />
        <textarea [(ngModel)]="templateForm.body" rows="2" [placeholder]="i18n.text('Body', 'النص')"></textarea>
        <button type="button" (click)="saveNotificationTemplate()" [disabled]="saving()">{{ i18n.text('Save Template', 'حفظ القالب') }}</button>
      </div>
      <div class="form">
        <input [(ngModel)]="queueForm.recipientValue" [placeholder]="i18n.text('Recipient', 'المستلم')" />
        <input [value]="i18n.text('Email only', 'البريد الإلكتروني فقط')" readonly />
        <input [(ngModel)]="queueForm.templateCode" [placeholder]="i18n.text('Template Code', 'رمز القالب')" />
        <button type="button" (click)="enqueueNotification()" [disabled]="saving()">{{ i18n.text('Queue Notification', 'جدولة الإشعار') }}</button>
      </div>
      <small>{{ notificationTemplates().length }} {{ i18n.text('templates', 'قالب') }}, {{ notificationQueue().length }} {{ i18n.text('queue records', 'سجل انتظار') }}</small>
      <ul>
        @for (item of notificationTemplates(); track item.id) {
          <li>
            <span>{{ codeLabel(item.templateCode) }} - {{ channelLabel(item.channel) }}</span>
            @if (showTechnicalCodes()) {
              <small class="code-tech">{{ item.templateCode }} / {{ item.channel }}</small>
            }
          </li>
        }
      </ul>
    </article>

    <article>
      <h2>{{ i18n.text('Escalations', 'التصعيدات') }}</h2>
      <small>{{ filteredEscalationNotifications().length }} {{ i18n.text('SLA escalation notifications', 'إشعار تصعيد SLA') }}</small>
      <div class="form">
        <button type="button" (click)="escalationStatusFilter.set('All')" [disabled]="saving()">{{ i18n.text('All', 'الكل') }}</button>
        <button type="button" (click)="escalationStatusFilter.set('Queued')" [disabled]="saving()">{{ i18n.text('Queued', 'في الانتظار') }}</button>
        <button type="button" (click)="escalationStatusFilter.set('Sent')" [disabled]="saving()">{{ i18n.text('Sent', 'تم الإرسال') }}</button>
        <button type="button" (click)="escalationStatusFilter.set('Failed')" [disabled]="saving()">{{ i18n.text('Failed', 'فشل') }}</button>
      </div>
      @if (filteredEscalationNotifications().length === 0) {
        <p>{{ i18n.text('No escalation notifications yet.', 'لا توجد إشعارات تصعيد حتى الآن.') }}</p>
      } @else {
        <table>
          <thead>
            <tr>
              <th>{{ i18n.text('Period', 'الفترة') }}</th>
              <th>{{ i18n.text('Run', 'التشغيل') }}</th>
              <th>{{ i18n.text('Stage', 'المرحلة') }}</th>
              <th>{{ i18n.text('Escalated To', 'مُصعّد إلى') }}</th>
              <th>{{ i18n.text('Channel', 'القناة') }}</th>
              <th>{{ i18n.text('Recipient', 'المستلم') }}</th>
              <th>{{ i18n.text('Status', 'الحالة') }}</th>
              <th>{{ i18n.text('Scheduled', 'وقت الجدولة') }}</th>
            </tr>
          </thead>
          <tbody>
            @for (item of filteredEscalationNotifications(); track item.id) {
              <tr>
                <td>{{ item.period || '-' }}</td>
                <td>{{ item.runId || item.relatedEntityId || '-' }}</td>
                <td>{{ item.stageName || item.stageCode || '-' }}</td>
                <td>{{ item.escalatedToRole || '-' }}</td>
                <td>{{ item.channel }}</td>
                <td>{{ item.recipientValue }}</td>
                <td>{{ item.status }}</td>
                <td>{{ item.scheduledAtUtc | date: 'short' }}</td>
              </tr>
              @if (item.errorMessage) {
                <tr>
                  <td colspan="8">{{ i18n.text('Error', 'خطأ') }}: {{ item.errorMessage }}</td>
                </tr>
              }
            }
          </tbody>
        </table>
      }
    </article>

    <article>
      <h2>{{ i18n.text('Government Integration Sync', 'مزامنة التكامل الحكومي') }}</h2>
      <div class="form">
        <select [(ngModel)]="integrationForm.provider">
          <option value="Qiwa">Qiwa</option>
          <option value="Mudad">Mudad</option>
        </select>
        <input [(ngModel)]="integrationForm.operation" [placeholder]="i18n.text('Operation', 'العملية')" />
        <input [(ngModel)]="integrationForm.entityType" [placeholder]="i18n.text('Entity Type', 'نوع الكيان')" />
        <input [(ngModel)]="integrationForm.entityId" [placeholder]="i18n.text('Entity Id (optional)', 'معرّف الكيان (اختياري)')" />
        <input [(ngModel)]="integrationForm.deadlineAtUtc" type="datetime-local" [placeholder]="i18n.text('Deadline (optional)', 'الموعد النهائي (اختياري)')" />
        <textarea [(ngModel)]="integrationForm.requestPayloadJson" rows="2" [placeholder]="i18n.text('Request JSON', 'طلب JSON')"></textarea>
        <button type="button" (click)="queueIntegrationSyncJob()" [disabled]="saving()">{{ i18n.text('Queue Sync Job', 'إضافة مهمة مزامنة') }}</button>
      </div>

      <div class="stat-grid">
        <small>{{ i18n.text('Total', 'الإجمالي') }}: {{ integrationDashboard().total || 0 }}</small>
        <small>{{ i18n.text('Queued', 'في الانتظار') }}: {{ integrationDashboard().queued || 0 }}</small>
        <small>{{ i18n.text('Processing', 'قيد المعالجة') }}: {{ integrationDashboard().processing || 0 }}</small>
        <small>{{ i18n.text('Retry', 'إعادة المحاولة') }}: {{ integrationDashboard().retryScheduled || 0 }}</small>
        <small>{{ i18n.text('Dead Letter', 'فشل نهائي') }}: {{ integrationDashboard().deadLetter || 0 }}</small>
        <small>{{ i18n.text('Deadlines Missed', 'مواعيد فائتة') }}: {{ integrationDashboard().deadlinesMissed || 0 }}</small>
      </div>

      <div class="form">
        <button type="button" (click)="integrationStatusFilter.set('All')" [disabled]="saving()">{{ i18n.text('All', 'الكل') }}</button>
        <button type="button" (click)="integrationStatusFilter.set('Queued')" [disabled]="saving()">{{ i18n.text('Queued', 'في الانتظار') }}</button>
        <button type="button" (click)="integrationStatusFilter.set('RetryScheduled')" [disabled]="saving()">{{ i18n.text('Retry', 'إعادة المحاولة') }}</button>
        <button type="button" (click)="integrationStatusFilter.set('DeadLetter')" [disabled]="saving()">{{ i18n.text('Dead Letter', 'فشل نهائي') }}</button>
        <button type="button" (click)="integrationStatusFilter.set('Succeeded')" [disabled]="saving()">{{ i18n.text('Succeeded', 'ناجح') }}</button>
      </div>

      @if (filteredIntegrationJobs().length === 0) {
        <p>{{ i18n.text('No integration sync jobs found.', 'لا توجد مهام مزامنة تكامل.') }}</p>
      } @else {
        <table>
          <thead>
            <tr>
              <th>{{ i18n.text('Provider', 'المزوّد') }}</th>
              <th>{{ i18n.text('Operation', 'العملية') }}</th>
              <th>{{ i18n.text('Entity', 'الكيان') }}</th>
              <th>{{ i18n.text('Status', 'الحالة') }}</th>
              <th>{{ i18n.text('Attempts', 'المحاولات') }}</th>
              <th>{{ i18n.text('Next Attempt', 'المحاولة القادمة') }}</th>
              <th>{{ i18n.text('Deadline', 'الموعد النهائي') }}</th>
              <th>{{ i18n.text('Action', 'الإجراء') }}</th>
            </tr>
          </thead>
          <tbody>
            @for (item of filteredIntegrationJobs(); track item.id) {
              <tr>
                <td>{{ item.provider }}</td>
                <td>{{ item.operation }}</td>
                <td>{{ item.entityType }} {{ item.entityId || '' }}</td>
                <td>{{ item.status }}</td>
                <td>{{ item.attemptCount }}/{{ item.maxAttempts }}</td>
                <td>{{ item.nextAttemptAtUtc | date: 'short' }}</td>
                <td>{{ item.deadlineAtUtc ? (item.deadlineAtUtc | date: 'short') : '-' }}</td>
                <td>
                  <button
                    type="button"
                    (click)="retryIntegrationJob(item.id)"
                    [disabled]="saving() || (item.status !== 'DeadLetter' && item.status !== 'RetryScheduled')">
                    {{ i18n.text('Retry', 'إعادة') }}
                  </button>
                </td>
              </tr>
              @if (item.lastError) {
                <tr>
                  <td colspan="8">{{ i18n.text('Error', 'خطأ') }}: {{ item.lastError }}</td>
                </tr>
              }
            }
          </tbody>
        </table>
      }
    </article>

    <article>
      <h2>{{ i18n.text('Data Quality & Reconciliation', 'جودة البيانات والمطابقة') }}</h2>
      <div class="form">
        <button type="button" (click)="runDataQualityScan()" [disabled]="saving()">{{ i18n.text('Run Scan', 'تشغيل الفحص') }}</button>
        <button type="button" (click)="fixOpenIssues()" [disabled]="saving()">{{ i18n.text('Apply Auto Fixes', 'تطبيق الإصلاحات التلقائية') }}</button>
      </div>
      <small>{{ dataQualityIssues().length }} {{ i18n.text('open issues', 'مشكلة مفتوحة') }}</small>
    </article>
  </div>
</section>

