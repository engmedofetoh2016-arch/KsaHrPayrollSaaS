<section class="ops-page">
  <header>
    <h1>{{ i18n.text('Operations Studio', 'استوديو العمليات') }}</h1>
    <p>{{ i18n.text('Configure payroll workflows, compliance rules, forecasting, notifications, and data quality.', 'تهيئة سير عمل الرواتب وقواعد الامتثال والتنبؤات والإشعارات وجودة البيانات.') }}</p>
    <button type="button" (click)="refresh()" [disabled]="loading() || saving()">{{ i18n.text('Refresh', 'تحديث') }}</button>
    <button type="button" class="toggle-codes" (click)="toggleTechnicalCodes()">
      {{ showTechnicalCodes() ? i18n.text('Hide Technical Codes', 'إخفاء الأكواد التقنية') : i18n.text('Show Technical Codes', 'إظهار الأكواد التقنية') }}
    </button>
  </header>

  @if (error()) {
    <p class="error">{{ error() }}</p>
  }
  @if (message()) {
    <p class="message">{{ message() }}</p>
  }

  <div class="grid">
    <article>
      <h2>{{ i18n.text('Allowance Matrix', 'مصفوفة البدلات') }}</h2>
      <div class="form">
        <input [(ngModel)]="allowanceForm.policyName" [placeholder]="i18n.text('Policy Name', 'اسم السياسة')" />
        <input [(ngModel)]="allowanceForm.gradeCode" [placeholder]="i18n.text('Grade', 'الدرجة')" />
        <input [(ngModel)]="allowanceForm.locationCode" [placeholder]="i18n.text('Location', 'الموقع')" />
        <input [(ngModel)]="allowanceForm.housingAmount" type="number" [placeholder]="i18n.text('Housing', 'السكن')" />
        <input [(ngModel)]="allowanceForm.transportAmount" type="number" [placeholder]="i18n.text('Transport', 'النقل')" />
        <input [(ngModel)]="allowanceForm.mealAmount" type="number" [placeholder]="i18n.text('Meal', 'الوجبات')" />
        <input [(ngModel)]="allowanceForm.effectiveFrom" type="date" />
        <button type="button" (click)="saveAllowanceMatrix()" [disabled]="saving()">{{ i18n.text('Save Matrix Row', 'حفظ سطر المصفوفة') }}</button>
      </div>
      <small>{{ allowanceMatrix().length }} {{ i18n.text('rows', 'سجل') }}</small>
    </article>

    <article>
      <h2>{{ i18n.text('Payroll Approval Matrix', 'مصفوفة اعتماد الرواتب') }}</h2>
      <div class="form">
        <button type="button" (click)="seedApprovalMatrix()" [disabled]="saving()">{{ i18n.text('Seed Default Flow', 'تهيئة المسار الافتراضي') }}</button>
        <input [(ngModel)]="stageForm.stageCode" [placeholder]="i18n.text('Stage Code', 'رمز المرحلة')" />
        <small class="code-hint">
          {{ codeLabel(stageForm.stageCode) }}
          @if (showTechnicalCodes()) {
            <span class="code-tech">{{ stageForm.stageCode }}</span>
          }
        </small>
        <input [(ngModel)]="stageForm.stageName" [placeholder]="i18n.text('Stage Name', 'اسم المرحلة')" />
        <input [(ngModel)]="stageForm.stageOrder" type="number" [placeholder]="i18n.text('Order', 'الترتيب')" />
        <input [(ngModel)]="stageForm.approverRole" [placeholder]="i18n.text('Approver Role', 'دور المعتمد')" />
        <button type="button" (click)="saveApprovalStage()" [disabled]="saving()">{{ i18n.text('Save Stage', 'حفظ المرحلة') }}</button>
      </div>
      <small>{{ approvalMatrix().length }} {{ i18n.text('active stages', 'مرحلة نشطة') }}</small>
      <ul>
        @for (item of approvalMatrix(); track item.id) {
          <li>
            <span>{{ item.stageName || codeLabel(item.stageCode) }}</span>
            @if (showTechnicalCodes()) {
              <small class="code-tech">{{ item.stageCode }}</small>
            }
          </li>
        }
      </ul>
    </article>

    <article>
      <h2>{{ i18n.text('Compliance Rules Studio', 'استوديو قواعد الامتثال') }}</h2>
      <div class="form">
        <input [(ngModel)]="ruleForm.ruleCode" [placeholder]="i18n.text('Rule Code', 'رمز القاعدة')" />
        <small class="code-hint">
          {{ codeLabel(ruleForm.ruleCode) }}
          @if (showTechnicalCodes()) {
            <span class="code-tech">{{ ruleForm.ruleCode }}</span>
          }
        </small>
        <input [(ngModel)]="ruleForm.ruleName" [placeholder]="i18n.text('Rule Name', 'اسم القاعدة')" />
        <input [(ngModel)]="ruleForm.ruleCategory" [placeholder]="i18n.text('Category', 'الفئة')" />
        <input [(ngModel)]="ruleForm.severity" [placeholder]="i18n.text('Severity', 'الأولوية')" />
        <textarea [(ngModel)]="ruleForm.ruleConfigJson" rows="3" [placeholder]="i18n.text('Rule Config JSON', 'إعداد القاعدة (JSON)')"></textarea>
        <button type="button" (click)="saveComplianceRule()" [disabled]="saving()">{{ i18n.text('Save Rule', 'حفظ القاعدة') }}</button>
      </div>
      <small>{{ complianceRules().length }} {{ i18n.text('enabled rules', 'قاعدة مفعلة') }}</small>
      <ul>
        @for (item of complianceRules(); track item.id) {
          <li>
            <span>{{ item.ruleName || codeLabel(item.ruleCode) }}</span>
            @if (showTechnicalCodes()) {
              <small class="code-tech">{{ item.ruleCode }}</small>
            }
          </li>
        }
      </ul>
    </article>

    <article>
      <h2>{{ i18n.text('Analytics & Forecasting', 'التحليلات والتنبؤ') }}</h2>
      <div class="form">
        <input [(ngModel)]="forecastForm.scenarioName" [placeholder]="i18n.text('Scenario Name', 'اسم السيناريو')" />
        <input [(ngModel)]="forecastForm.plannedSaudiHires" type="number" [placeholder]="i18n.text('Saudi Hires', 'توظيف سعوديين')" />
        <input [(ngModel)]="forecastForm.plannedNonSaudiHires" type="number" [placeholder]="i18n.text('Non-Saudi Hires', 'توظيف غير سعوديين')" />
        <input [(ngModel)]="forecastForm.plannedAttrition" type="number" [placeholder]="i18n.text('Attrition', 'الاستقالات/المغادرات')" />
        <input [(ngModel)]="forecastForm.plannedSalaryDeltaPercent" type="number" [placeholder]="i18n.text('Salary Delta %', 'نسبة تغير الرواتب %')" />
        <button type="button" (click)="createForecastScenario()" [disabled]="saving()">{{ i18n.text('Create Scenario', 'إنشاء سيناريو') }}</button>
      </div>
      <ul>
        @for (item of forecastScenarios(); track item.id) {
          <li>
            {{ item.scenarioName }}
            <button type="button" (click)="runForecastScenario(item.id)" [disabled]="saving()">{{ i18n.text('Run', 'تشغيل') }}</button>
          </li>
        }
      </ul>
    </article>
    <article>
      <h2>{{ i18n.text('ESS Requests Review', 'مراجعة طلبات الخدمة الذاتية') }}</h2>
      <small>{{ selfServiceRequests().length }} {{ i18n.text('submitted requests', 'طلبات مرسلة') }}</small>
      <ul>
        @for (item of selfServiceRequests(); track item.id) {
          <li>
            <span>{{ item.employeeName || '-' }} - {{ codeLabel(item.requestType) }} ({{ item.status }})</span>
            <button type="button" (click)="reviewSelfServiceRequest(item.id, true)" [disabled]="saving()">{{ i18n.text('Approve', 'اعتماد') }}</button>
            <button type="button" (click)="reviewSelfServiceRequest(item.id, false)" [disabled]="saving()">{{ i18n.text('Reject', 'رفض') }}</button>
          </li>
        }
      </ul>
    </article>

    <article>
      <h2>{{ i18n.text('Notification Center', 'مركز الإشعارات') }}</h2>
      <div class="form">
        <input [(ngModel)]="templateForm.templateCode" [placeholder]="i18n.text('Template Code', 'رمز القالب')" />
        <small class="code-hint">
          {{ codeLabel(templateForm.templateCode) }}
          @if (showTechnicalCodes()) {
            <span class="code-tech">{{ templateForm.templateCode }}</span>
          }
        </small>
        <input [value]="i18n.text('Email only', 'البريد الإلكتروني فقط')" readonly />
        <input [(ngModel)]="templateForm.subject" [placeholder]="i18n.text('Subject', 'العنوان')" />
        <textarea [(ngModel)]="templateForm.body" rows="2" [placeholder]="i18n.text('Body', 'النص')"></textarea>
        <button type="button" (click)="saveNotificationTemplate()" [disabled]="saving()">{{ i18n.text('Save Template', 'حفظ القالب') }}</button>
      </div>
      <div class="form">
        <input [(ngModel)]="queueForm.recipientValue" [placeholder]="i18n.text('Recipient', 'المستلم')" />
        <input [value]="i18n.text('Email only', 'البريد الإلكتروني فقط')" readonly />
        <input [(ngModel)]="queueForm.templateCode" [placeholder]="i18n.text('Template Code', 'رمز القالب')" />
        <button type="button" (click)="enqueueNotification()" [disabled]="saving()">{{ i18n.text('Queue Notification', 'جدولة الإشعار') }}</button>
      </div>
      <small>{{ notificationTemplates().length }} {{ i18n.text('templates', 'قالب') }}, {{ notificationQueue().length }} {{ i18n.text('queue records', 'سجل انتظار') }}</small>
      <ul>
        @for (item of notificationTemplates(); track item.id) {
          <li>
            <span>{{ codeLabel(item.templateCode) }} - {{ channelLabel(item.channel) }}</span>
            @if (showTechnicalCodes()) {
              <small class="code-tech">{{ item.templateCode }} / {{ item.channel }}</small>
            }
          </li>
        }
      </ul>
    </article>

    <article>
      <h2>{{ i18n.text('Data Quality & Reconciliation', 'جودة البيانات والمطابقة') }}</h2>
      <div class="form">
        <button type="button" (click)="runDataQualityScan()" [disabled]="saving()">{{ i18n.text('Run Scan', 'تشغيل الفحص') }}</button>
        <button type="button" (click)="fixOpenIssues()" [disabled]="saving()">{{ i18n.text('Apply Auto Fixes', 'تطبيق الإصلاحات التلقائية') }}</button>
      </div>
      <small>{{ dataQualityIssues().length }} {{ i18n.text('open issues', 'مشكلة مفتوحة') }}</small>
    </article>
  </div>
</section>

